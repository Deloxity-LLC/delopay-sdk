name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: read
  id-token: write
  attestations: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: "22"
          registry-url: "https://registry.npmjs.org"
          cache: "npm"

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: npm ci

      - name: Ensure Gradle wrapper is executable
        run: chmod +x ./sdks/java/gradlew

      - name: Verify version against tag
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          FILE_VERSION="$(cat VERSION)"
          if [ "$TAG_VERSION" != "$FILE_VERSION" ]; then
            echo "Tag version ($TAG_VERSION) does not match VERSION ($FILE_VERSION)"
            exit 1
          fi

      - name: Generate SDK baselines
        run: npm run generate

      - name: Build all SDKs
        run: npm run build

      - name: Test all SDKs
        run: npm run test

      - name: Pack TypeScript SDK artifact
        run: npm pack ./sdks/typescript --pack-destination ./sdks/typescript

      - name: Publish TypeScript SDK to npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ -z "$NODE_AUTH_TOKEN" ]; then
            echo "NPM_TOKEN is not configured. Skipping npm publish."
            exit 0
          fi
          npm publish ./sdks/typescript --access public

      - name: Publish Java SDK to Maven Central
        env:
          MAVEN_CENTRAL_USERNAME: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          MAVEN_CENTRAL_PASSWORD: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          MAVEN_GPG_PRIVATE_KEY: ${{ secrets.MAVEN_GPG_PRIVATE_KEY }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.MAVEN_GPG_PASSPHRASE }}
        run: |
          if [ -z "$MAVEN_CENTRAL_USERNAME" ] || [ -z "$MAVEN_CENTRAL_PASSWORD" ]; then
            echo "Maven Central credentials are not configured. Skipping Java publish."
            exit 0
          fi
          ./sdks/java/gradlew -p ./sdks/java publish

      - name: Build Python package
        env:
          PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          if [ -z "$PYPI_API_TOKEN" ]; then
            echo "PYPI_API_TOKEN is not configured. Skipping Python package build."
            exit 0
          fi
          python -m pip install --upgrade pip build twine
          python -m build ./sdks/python

      - name: Publish Python SDK to PyPI
        env:
          PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          if [ -z "$PYPI_API_TOKEN" ]; then
            echo "PYPI_API_TOKEN is not configured. Skipping PyPI publish."
            exit 0
          fi
          python -m twine upload ./sdks/python/dist/*

      - name: Generate artifact checksums
        shell: bash
        run: |
          set -euo pipefail
          find ./sdks/typescript -maxdepth 1 -type f -name '*.tgz' -print0 | xargs -0 -r sha256sum > checksums-typescript.sha256
          find ./sdks/java/build/libs -maxdepth 1 -type f -name '*.jar' -print0 | xargs -0 -r sha256sum > checksums-java.sha256
          find ./sdks/python/dist -maxdepth 1 -type f \\( -name '*.whl' -o -name '*.tar.gz' \\) -print0 | xargs -0 -r sha256sum > checksums-python.sha256

      - name: Upload checksum artifacts
        uses: actions/upload-artifact@v6
        with:
          name: release-checksums
          path: |
            checksums-typescript.sha256
            checksums-java.sha256
            checksums-python.sha256
          retention-days: 30

      - name: Attest TypeScript build provenance
        if: ${{ hashFiles('sdks/typescript/*.tgz') != '' }}
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: sdks/typescript/*.tgz

      - name: Attest Java build provenance
        if: ${{ hashFiles('sdks/java/build/libs/*.jar') != '' }}
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: sdks/java/build/libs/*.jar

      - name: Attest Python build provenance
        if: ${{ hashFiles('sdks/python/dist/*') != '' }}
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: sdks/python/dist/*
