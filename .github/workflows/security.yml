name: Security

on:
  push:
    branches:
      - dev
  pull_request:
  schedule:
    - cron: "0 3 * * 1"
  workflow_dispatch:

permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  sast-semgrep:
    name: SAST (Semgrep)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Run Semgrep (OWASP + Security Audit)
        run: |
          docker run --rm -v "$PWD:/src" returntocorp/semgrep:latest \
            semgrep scan \
            --config p/owasp-top-ten \
            --config p/security-audit \
            --severity ERROR \
            --error \
            --exclude .git \
            --exclude node_modules \
            --exclude dist \
            --exclude generated \
            /src

  sast-codeql:
    name: SAST (CodeQL ${{ matrix.language }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        language:
          - javascript-typescript
          - java-kotlin
          - python

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}

      - name: Setup Java
        if: matrix.language == 'java-kotlin'
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "17"

      - name: Ensure Gradle wrapper is executable
        if: matrix.language == 'java-kotlin'
        run: chmod +x ./sdks/java/gradlew

      - name: Build Java classes
        if: matrix.language == 'java-kotlin'
        run: ./sdks/java/gradlew -p ./sdks/java classes --no-daemon

      - name: Autobuild non-Java
        if: matrix.language != 'java-kotlin'
        uses: github/codeql-action/autobuild@v4

      - name: Analyze
        uses: github/codeql-action/analyze@v4

  sca-trivy-fs:
    name: SCA (Trivy FS)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Run Trivy vulnerability scan
        uses: aquasecurity/trivy-action@0.31.0
        with:
          scan-type: fs
          scan-ref: .
          scanners: vuln
          format: table
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          exit-code: '1'

  secrets-gitleaks:
    name: Secrets (Gitleaks)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Detect Gitleaks license
        id: gitleaks_license
        run: |
          if [ -n "${GITLEAKS_LICENSE}" ]; then
            echo "has_license=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_license=false" >> "$GITHUB_OUTPUT"
          fi
        env:
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: Run Gitleaks (licensed)
        if: ${{ steps.gitleaks_license.outputs.has_license == 'true' }}
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: Run Gitleaks (OSS fallback)
        if: ${{ steps.gitleaks_license.outputs.has_license != 'true' }}
        run: |
          docker run --rm -v "$PWD:/repo" ghcr.io/gitleaks/gitleaks:latest \
            detect --source=/repo --no-git --redact --exit-code 1

  sbom-cyclonedx:
    name: SBOM (CycloneDX)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          path: .
          format: cyclonedx-json
          output-file: sbom.cdx.json

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v6
        with:
          name: sbom-cyclonedx-sdk
          path: sbom.cdx.json
          retention-days: 14

  lockfile-integrity:
    name: Dependency lockfile integrity
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: npm

      - name: Verify deterministic root install
        run: npm ci --ignore-scripts

      - name: Ensure lockfile unchanged
        run: git diff --exit-code -- package-lock.json
